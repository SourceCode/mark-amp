name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-package:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            artifact_name: markamp-macOS
          - os: windows-latest
            artifact_name: markamp-Windows
          - os: ubuntu-latest
            artifact_name: markamp-Linux
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0 # Full history for changelog

      # ── System dependencies ──
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install ninja

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential ninja-build \
            libgtk-3-dev libwebkit2gtk-4.0-dev \
            libnotify-dev libsecret-1-dev \
            pkg-config dpkg-dev

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: choco install ninja nsis -y

      # ── vcpkg ──
      - name: Set up vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ github.workspace }}/external/vcpkg
          vcpkgJsonGlob: "**/vcpkg.json"

      # ── Build (Release) ──
      - name: Configure CMake
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DMARKAMP_BUILD_TESTS=ON \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/external/vcpkg/scripts/buildsystems/vcpkg.cmake

      - name: Build
        run: cmake --build build --parallel

      - name: Run tests
        working-directory: build
        run: ctest --output-on-failure --parallel 4

      # ── Package (macOS) ──
      - name: Package macOS
        if: runner.os == 'macOS'
        run: |
          chmod +x scripts/package_macos.sh
          ./scripts/package_macos.sh
        env:
          MARKAMP_SKIP_CODESIGN: "1"

      # ── Package (Linux) ──
      - name: Package Linux
        if: runner.os == 'Linux'
        run: |
          chmod +x scripts/package_linux.sh
          ./scripts/package_linux.sh

      # ── Package (Windows) ──
      - name: Package Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: ./scripts/package_windows.ps1

      # ── Upload artifacts ──
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/*
          retention-days: 30

  # ── Create GitHub Release ──
  create-release:
    needs: build-and-package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [[ -n "${PREV_TAG}" ]]; then
            CHANGES=$(git log "${PREV_TAG}..HEAD" --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGES=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi
          echo "changes<<EOF" >> "$GITHUB_OUTPUT"
          echo "${CHANGES}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: |
            ## MarkAmp ${{ github.ref_name }}

            ### Changes
            ${{ steps.changelog.outputs.changes }}

            ### Downloads
            | Platform | File |
            |----------|------|
            | macOS    | `MarkAmp-macOS.dmg` |
            | Windows  | `MarkAmp-Windows-Setup.exe` / Portable ZIP |
            | Linux    | `.deb` / `.AppImage` / `.tar.gz` |
          files: release-artifacts/**/*
          draft: false
          prerelease: false
